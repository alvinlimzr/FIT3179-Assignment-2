{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "width": 960,
  "height": 520,
  "background": "white",
  "title": {"text": "Country trajectories: life expectancy vs GDP per capita (1960–2024)", "anchor": "start"},
  "data": {"url": "data/Life_expectancy.csv", "format": {"type": "csv"}},
  "params": [
    {
      "name": "countries",
      "value": ["CHN", "IND", "USA", "SGP"]
    }
  ],
  "transform": [
    {
      "fold": [
        "1960","1961","1962","1963","1964","1965","1966","1967","1968","1969",
        "1970","1971","1972","1973","1974","1975","1976","1977","1978","1979",
        "1980","1981","1982","1983","1984","1985","1986","1987","1988","1989",
        "1990","1991","1992","1993","1994","1995","1996","1997","1998","1999",
        "2000","2001","2002","2003","2004","2005","2006","2007","2008","2009",
        "2010","2011","2012","2013","2014","2015","2016","2017","2018","2019",
        "2020","2021","2022","2023","2024"
      ],
      "as": ["year", "lifeRaw"]
    },
    {"calculate": "toNumber(datum.lifeRaw)", "as": "life"},
    {"calculate": "toNumber(datum.year)", "as": "yearNum"},
    {"filter": "indexof(countries, datum['Country Code']) >= 0"},
    {
      "lookup": "Country Code",
      "from": {
        "data": {"url": "data/gdp_pc_cleaned.csv", "format": {"type": "csv"}},
        "key": "Country Code",
        "fields": [
          "1960","1970","1980","1990","2000","2010","2015",
          "2018","2019","2020","2021","2022","2023","2024",
          "Country Name"
        ]
      },
      "as": [
        "g1960","g1970","g1980","g1990","g2000","g2010","g2015",
        "g2018","g2019","g2020","g2021","g2022","g2023","g2024",
        "GDP Country"
      ]
    },
    {
      "calculate": "datum.yearNum <= 1965 ? 1960 : datum.yearNum <= 1975 ? 1970 : datum.yearNum <= 1985 ? 1980 : datum.yearNum <= 1995 ? 1990 : datum.yearNum <= 2005 ? 2000 : datum.yearNum <= 2012 ? 2010 : datum.yearNum <= 2017 ? 2015 : datum.yearNum <= 2018 ? 2018 : datum.yearNum <= 2019 ? 2019 : datum.yearNum <= 2020 ? 2020 : datum.yearNum <= 2021 ? 2021 : datum.yearNum <= 2022 ? 2022 : datum.yearNum <= 2023 ? 2023 : 2024",
      "as": "gYear"
    },
    {"calculate": "toNumber(datum['g' + datum.gYear])", "as": "gdp"},
    {
      "filter": "isValid(datum.life) && isFinite(datum.life) && isValid(datum.gdp) && isFinite(datum.gdp) && datum.gdp > 0"
    },
    {"calculate": "datum.yearNum % 10 === 0 ? '●' : ''", "as": "decadeDot"}
  ],
  "layer": [
    {
      "mark": {"type": "line", "opacity": 0.95, "strokeWidth": 2},
      "encoding": {
        "x": {"field": "gdp", "type": "quantitative", "title": "GDP per capita (current US$)", "scale": {"type": "log", "nice": true, "clamp": true}},
        "y": {"field": "life", "type": "quantitative", "title": "Life expectancy at birth (years)"},
        "color": {"field": "Country Name", "type": "nominal", "legend": {"title": "Country"}},
        "detail": {"field": "Country Code"},
        "order": {"field": "yearNum"}
      }
    },
    {
      "mark": {"type": "point", "filled": true, "size": 36, "opacity": 0.85},
      "encoding": {
        "x": {"field": "gdp", "type": "quantitative", "scale": {"type": "log"}},
        "y": {"field": "life", "type": "quantitative"},
        "color": {"field": "Country Name", "type": "nominal"},
        "tooltip": [
          {"field": "Country Name", "title": "Country"},
          {"field": "Country Code", "title": "ISO3"},
          {"field": "yearNum", "title": "Year"},
          {"field": "gYear", "title": "GDP year used"},
          {"field": "gdp", "title": "GDP per cap.", "format": ",.0f"},
          {"field": "life", "title": "Life exp. (yrs)", "format": ".1f"}
        ]
      }
    },
    {
      "transform": [{"filter": "datum.decadeDot === '●'"}],
      "mark": {"type": "text", "dy": -8, "fontSize": 10},
      "encoding": {
        "x": {"field": "gdp", "type": "quantitative", "scale": {"type": "log"}},
        "y": {"field": "life", "type": "quantitative"},
        "text": {"field": "yearNum"}
      }
    }
  ],
  "config": { "view": { "stroke": null } }
}
